{% extends "base.html" %}
{% block title %}üì¶ Inventario{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- üîπ Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">üì¶ Control de Inventario</h2>
    <div class="d-flex gap-2">
      <!-- ‚úÖ Redirige al mismo formulario que el index -->
      <a href="{{ url_for('app_rutas.nuevo_producto') }}" class="btn btn-primary fw-bold">
        ‚ûï Nuevo Producto
      </a>
      <a href="{{ url_for('app_rutas.index') }}" class="btn btn-secondary fw-bold">
        ‚¨Ö Volver al Inicio
      </a>
    </div>
  </div>

  <!-- üßæ Formulario de Entrada -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">üì• Registrar Entrada de Producto Existente</h5>
    </div>
    <div class="card-body">
      <form method="POST" class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-bold">C√≥digo del Producto</label>
          <input type="text" name="codigo" class="form-control" placeholder="Ej: 123456" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold">Cantidad a Ingresar</label>
          <input type="number" name="cantidad" class="form-control" min="1" required>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-success w-100 fw-bold">
            üíæ Registrar Entrada
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- üìã Tabla de Productos -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üìä Inventario Actual</h5>
      <small class="text-light">√öltima actualizaci√≥n autom√°tica</small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="tabla-productos" class="table table-hover align-middle text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th>Orden</th>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>Valor Unitario</th>
              <th>Ganancia (%)</th>
              <th>Stock</th>
            </tr>
          </thead>
          <tbody>
            {% if productos %}
              {% for p in productos %}
              <tr>
                <td>{{ p.orden }}</td>
                <td>{{ p.codigo }}</td>
                <td class="fw-bold">{{ p.nombre }}</td>
                <td>${{ "%.2f"|format(p.valor_unitario) }}</td>
                <td>{{ "%.1f"|format(p.interes) }}%</td>
                <td>{{ p.unidades_restantes }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-3">‚ö†Ô∏è No hay productos en inventario.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- üìú Historial -->
  <div class="card shadow-sm mt-4 border-0">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üïí Historial de Entradas (√∫ltimos 90 d√≠as)</h5>
      <small class="text-light">Se limpia autom√°ticamente</small>
    </div>
    <div class="card-body p-0">
      {% if historial %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Valor Total</th>
            </tr>
          </thead>
          <tbody>
            {% for h in historial %}
            <tr>
              <td>{{ h.fecha.strftime("%d-%m-%Y") }}</td>
              <td>{{ h.producto.codigo }}</td>
              <td class="fw-bold">{{ h.producto.nombre }}</td>
              <td>{{ h.cantidad }}</td>
              <td>${{ "%.2f"|format(h.valor_total) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-4 text-center text-muted">Sin registros en los √∫ltimos 90 d√≠as.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
  // Inicializa DataTables
  $('#tabla-productos').DataTable({
    pageLength: 10,
    order: [[0, 'asc']],
    language: {
      url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
    }
  });
});
</script>
{% endblock %}
