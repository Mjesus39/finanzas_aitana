{% extends "base.html" %}
{% block title %}üì¶ Inventario{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- üîπ Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">üì¶ Control de Inventario</h2>
    <div class="d-flex gap-2">
      <a href="{{ url_for('app_rutas.nuevo_producto') }}" class="btn btn-primary fw-bold">
        ‚ûï Nuevo Producto
      </a>
      <a href="{{ url_for('app_rutas.index') }}" class="btn btn-secondary fw-bold">
        ‚¨Ö Volver al Inicio
      </a>
    </div>
  </div>

  <!-- üßæ Formulario de Entrada -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">üì• Registrar Entrada de Producto Existente</h5>
    </div>
    <div class="card-body">
      <form method="POST" class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-bold">C√≥digo del Producto</label>
          <input type="text" name="codigo" class="form-control" placeholder="Ej: 123456" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold">Cantidad a Ingresar</label>
          <input type="number" name="cantidad" class="form-control" min="1" required>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-success w-100 fw-bold">
            üíæ Registrar Entrada
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- üìã Tabla de Productos -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üìä Inventario Actual</h5>
      <small class="text-light">√öltima actualizaci√≥n autom√°tica</small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="tabla-productos" class="table table-hover align-middle text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>üí∞ Precio con Ganancia</th>
              <th>Stock</th>
              <th>‚öôÔ∏è Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% if productos %}
              {% for p in productos %}
              {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
              <tr id="producto-{{ p.id }}">
                <td>{{ p.codigo }}</td>
                <td class="nombre fw-bold" data-id="{{ p.id }}">{{ p.nombre }}</td>
                <td class="precio text-success fw-bold" data-id="{{ p.id }}">
                  ${{ "%.2f"|format(precio_ganancia) }}
                </td>
                <td>{{ p.unidades_restantes }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary editar-producto" data-id="{{ p.id }}">
                    ‚úèÔ∏è Editar
                  </button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-3">‚ö†Ô∏è No hay productos en inventario.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- üìú Historial -->
  <div class="card shadow-sm mt-4 border-0">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üïí Historial de Entradas (√∫ltimos 90 d√≠as)</h5>
      <small class="text-light">Se limpia autom√°ticamente</small>
    </div>
    <div class="card-body p-0">
      {% if historial %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle text-center mb-0">
          <thead class="table-dark">
            <tr>
              <th>‚ùå</th>
              <th>Fecha y Hora</th>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Valor Total</th>
            </tr>
          </thead>
          <tbody>
            {% for h in historial %}
            <tr id="entrada-{{ h.id }}">
              <td>
                <button class="btn btn-sm btn-outline-danger eliminar-entrada" data-id="{{ h.id }}">‚úñ</button>
              </td>
              <td>{{ h.fecha|hora_chile }}</td>
              <td>{{ h.producto.codigo }}</td>
              <td class="fw-bold">{{ h.producto.nombre }}</td>
              <td>{{ h.cantidad }}</td>
              <td>${{ "%.2f"|format(h.valor_total) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="p-4 text-center text-muted">Sin registros en los √∫ltimos 90 d√≠as.</div>
      {% endif %}
    </div>
  </div>

</div>

<!-- ‚úÖ Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-success" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body fw-bold" id="toast-success-text">‚úÖ Acci√≥n completada correctamente.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>

  <div id="toast-error" class="toast align-items-center text-bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body fw-bold" id="toast-error-text">‚ùå Error al realizar la acci√≥n.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
  $('#tabla-productos').DataTable({
    pageLength: 10,
    order: [[0, 'asc']],
    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' }
  });
});
</script>

<!-- ‚úèÔ∏è Editar nombre y precio -->
<script>
document.addEventListener("click", async function (e) {
  const btn = e.target.closest(".editar-producto");
  if (!btn) return;

  const id = btn.dataset.id;
  const nombreCelda = document.querySelector(`#producto-${id} .nombre`);
  const precioCelda = document.querySelector(`#producto-${id} .precio`);
  const nombreActual = nombreCelda.textContent.trim();
  const precioActual = parseFloat(precioCelda.textContent.replace("$", "").trim());

  // Inputs
  nombreCelda.innerHTML = `<input type="text" class="form-control text-center fw-bold" value="${nombreActual}">`;
  precioCelda.innerHTML = `<input type="number" min="0" step="0.01" class="form-control text-center fw-bold" value="${precioActual.toFixed(2)}">`;

  const inputNombre = nombreCelda.querySelector("input");
  const inputPrecio = precioCelda.querySelector("input");
  inputNombre.focus();

  const toastOk = new bootstrap.Toast(document.getElementById("toast-success"), { delay: 2000 });
  const toastErr = new bootstrap.Toast(document.getElementById("toast-error"), { delay: 3000 });
  const okText = document.getElementById("toast-success-text");
  const errText = document.getElementById("toast-error-text");

  async function guardar() {
    const nuevoNombre = inputNombre.value.trim();
    const nuevoPrecio = parseFloat(inputPrecio.value);
    if (!nuevoNombre || isNaN(nuevoPrecio) || nuevoPrecio <= 0) {
      errText.textContent = "‚ö†Ô∏è Datos inv√°lidos.";
      toastErr.show();
      nombreCelda.textContent = nombreActual;
      precioCelda.textContent = `$${precioActual.toFixed(2)}`;
      return;
    }

    try {
      const res = await fetch(`/actualizar_producto/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre: nuevoNombre, precio: nuevoPrecio })
      });
      const data = await res.json();

      if (data.success) {
        nombreCelda.textContent = nuevoNombre;
        precioCelda.textContent = `$${nuevoPrecio.toFixed(2)}`;
        okText.textContent = data.message;
        toastOk.show();
      } else {
        errText.textContent = data.error || "‚ùå Error al actualizar.";
        toastErr.show();
        nombreCelda.textContent = nombreActual;
        precioCelda.textContent = `$${precioActual.toFixed(2)}`;
      }
    } catch {
      errText.textContent = "‚ùå Error de conexi√≥n con el servidor.";
      toastErr.show();
      nombreCelda.textContent = nombreActual;
      precioCelda.textContent = `$${precioActual.toFixed(2)}`;
    }
  }

  inputPrecio.addEventListener("blur", guardar);
  inputPrecio.addEventListener("keydown", e => { if (e.key === "Enter") guardar(); });
  inputNombre.addEventListener("keydown", e => { if (e.key === "Enter") guardar(); });
});
</script>

<!-- üóëÔ∏è Eliminar entrada del historial -->
<script>
document.addEventListener("click", async function (e) {
  const btn = e.target.closest(".eliminar-entrada");
  if (!btn) return;

  const id = btn.dataset.id;
  if (!confirm("¬øEliminar esta entrada del historial? Esta acci√≥n reducir√° el stock.")) return;

  const toastOk = new bootstrap.Toast(document.getElementById("toast-success"), { delay: 2000 });
  const toastErr = new bootstrap.Toast(document.getElementById("toast-error"), { delay: 3000 });
  const okText = document.getElementById("toast-success-text");
  const errText = document.getElementById("toast-error-text");

  try {
    const res = await fetch(`/eliminar_entrada_inventario/${id}`, { method: "DELETE" });
    const data = await res.json();

    if (data.success) {
      document.getElementById(`entrada-${id}`).remove();
      okText.textContent = "‚úÖ Entrada eliminada correctamente.";
      toastOk.show();
    } else {
      errText.textContent = data.error || "‚ùå No se pudo eliminar.";
      toastErr.show();
    }
  } catch {
    errText.textContent = "‚ùå Error de conexi√≥n con el servidor.";
    toastErr.show();
  }
});
</script>
{% endblock %}
