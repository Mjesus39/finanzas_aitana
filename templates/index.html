{% extends "base.html" %}
{% block title %}Inventario{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">📦 Inventario de Productos</h2>

  <!-- 🔹 Encabezado -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 gap-2">
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-primary" href="{{ url_for('app_rutas.nuevo_producto') }}">➕ Nuevo Producto</a>
      <a class="btn btn-secondary" href="{{ url_for('app_rutas.liquidacion') }}">📊 Ver Liquidación</a>
    </div>
    <input type="text" id="buscar-producto" class="form-control mt-2 mt-md-0" placeholder="🔍 Buscar por código o nombre...">
  </div>

  {% if productos %}
  <div class="table-responsive">
    <table id="tabla-productos" class="table table-bordered table-hover align-middle text-center shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>Orden</th>
          <th>Código</th>
          <th>Nombre</th>
          <th>Precio con Ganancia</th>
          <th>Stock Actual</th>
          <th>Vender</th>
          <th>Vendidas Hoy</th>
          <th>Valor Vendido</th>
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
        {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
        <tr id="producto-{{ p.id }}" class="{{ estado_class(p) }}">
          <td>{{ p.orden }}</td>
          <td class="col-codigo">{{ p.codigo }}</td>
          <td class="fw-bold col-nombre">{{ p.nombre }}</td>
          <td class="precio-ganancia">{{ "%.2f"|format(precio_ganancia) }}</td>
          <td class="stock-actual">{{ p.unidades_restantes or 0 }}</td>

          <!-- Formulario de venta (AJAX) -->
          <td>
            <form class="form-vender d-flex justify-content-center" 
                  data-id="{{ p.id }}" 
                  data-action="{{ url_for('app_rutas.vender', producto_id=p.id) }}">
              <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad"
                     placeholder="0" class="form-control text-end cantidad-input fs-5 fw-bold"
                     style="width:110px; height:46px;" required>
              <button type="submit" class="btn btn-success ms-2 fs-5 btn-vender">💵</button>
            </form>
          </td>

          <td class="vendidas-dia">{{ p.vendidas_dia or 0 }}</td>
          <td class="valor-vendido-dia">{{ "%.2f"|format(p.valor_vendido_dia or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light">
        <tr>
          <th colspan="7" class="text-end">Total Vendido Hoy:</th>
          <th id="total-vendido-hoy">{{ "%.2f"|format(total_vendido or 0) }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info text-center mt-4">No hay productos registrados todavía.</div>
  {% endif %}
</div>

<!-- ✅ Toasts (éxito / error) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast-success" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-success-text">Venta registrada.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
  <div id="toast-error" class="toast align-items-center text-bg-danger border-0 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-error-text">Error al registrar la venta.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  // 🔍 Búsqueda en vivo (por código o nombre)
  const inputBuscar = $("#buscar-producto");
  if (inputBuscar) {
    inputBuscar.addEventListener("keyup", () => {
      const f = inputBuscar.value.toLowerCase();
      $$("#tabla-productos tbody tr").forEach(tr => {
        const codigo = tr.querySelector(".col-codigo")?.textContent.toLowerCase() || "";
        const nombre = tr.querySelector(".col-nombre")?.textContent.toLowerCase() || "";
        tr.style.display = (codigo.includes(f) || nombre.includes(f)) ? "" : "none";
      });
    });
  }

  // 🎵 Toasts
  const toastOk = new bootstrap.Toast($("#toast-success"), { delay: 2000 });
  const toastErr = new bootstrap.Toast($("#toast-error"), { delay: 3000 });
  const okText = $("#toast-success-text"), errText = $("#toast-error-text");

  // 🧮 Helpers
  const toNum = (txt) => parseFloat(String(txt).replaceAll(",", "").trim()) || 0;
  const fmt2  = (n) => (Math.round(n * 100) / 100).toFixed(2);

  // 🛒 Venta AJAX correcta (sin recargar)
  $$(".form-vender").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // ✅ evita el GET /?cantidad=1
      const btn = form.querySelector(".btn-vender");
      const input = form.querySelector("input[name='cantidad']");
      const cantidad = parseInt(input.value);
      const id = form.dataset.id;
      const action = form.dataset.action;

      const fila = $("#producto-" + id);
      const stockEl = fila.querySelector(".stock-actual");
      const vendidasEl = fila.querySelector(".vendidas-dia");
      const valorEl = fila.querySelector(".valor-vendido-dia");
      const totalEl = $("#total-vendido-hoy");

      if (!cantidad || cantidad <= 0) {
        errText.textContent = "Cantidad inválida.";
        toastErr.show();
        return;
      }

      btn.disabled = true;

      try {
        const res = await fetch(action, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cantidad })
        });

        const data = await res.json();
        if (data.success) {
          stockEl.textContent = data.stock;
          vendidasEl.textContent = data.vendidas_dia;
          valorEl.textContent = fmt2(data.valor_vendido_dia);
          totalEl.textContent = fmt2(toNum(totalEl.textContent) + data.monto);

          okText.textContent = `✅ Venta registrada: ${data.nombre} (${cantidad})`;
          toastOk.show();
          input.value = "";
        } else {
          errText.textContent = data.error || "Error al registrar venta.";
          toastErr.show();
        }
      } catch (err) {
        errText.textContent = "Error de conexión con el servidor.";
        toastErr.show();
      } finally {
        btn.disabled = false;
      }
    });
  });
})();
</script>

<style>
.table td, .table th { vertical-align: middle !important; }
.table-danger td { background-color: #f8d7da !important; }
</style>
{% endblock %}
