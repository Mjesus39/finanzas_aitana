{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Productos</h2>

<div class="mb-3 d-flex flex-column flex-md-row gap-2">
    <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-primary" href="{{ url_for('nuevo_producto') }}">‚ûï Nuevo Producto</a>
        <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
    </div>
    <input type="text" id="buscar-producto" class="form-control mt-2 mt-md-0" placeholder="Buscar producto por nombre o c√≥digo...">
</div>

{% if productos %}
<table id="tabla-productos" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Precio con Ganancia</th>
      <th>Unidades Iniciales</th>
      <th>Vender</th>
      <th>Unidades Vendidas (d√≠a)</th>
      <th>Valor Vendido (d√≠a)</th>
      <th>üí≤ Editar Precio</th> <!-- Nueva columna -->
    </tr>
  </thead>
  <tbody>
    {% for p in productos %}
    {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    <tr id="producto-{{ p.id }}" class="{{ estado_class(p) }}">
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden_producto', producto_id=p.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ p.orden }}" class="form-control text-center" style="width:70px;">
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm">‚úî</button>
        </form>
      </td>

      <td>{{ p.codigo }}</td>
      <td>{{ p.nombre }}</td>
      <td class="precio-ganancia">{{ "%.2f"|format(precio_ganancia) }}</td>
      <td class="stock-actual">{{ p.unidades_restantes or 0 }}</td>

      <!-- Input de venta -->
      <td>
        <form action="{{ url_for('vender', producto_id=p.id) }}" method="post" class="d-flex form-vender justify-content-center">
          <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad"
                 placeholder="0" class="form-control text-end cantidad-input fs-5 fw-bold" 
                 style="width:120px; height:50px; font-size:1.4rem;" required>
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>
      </td>

      <td class="vendidas-dia fs-6">{{ p.vendidas_dia or 0 }}</td>
      <td class="valor-vendido-dia fs-6">{{ "%.2f"|format(p.valor_vendido_dia or 0) }}</td>

      <!-- Nueva celda para editar precio -->
      <td>
        <form class="form-editar-precio d-flex justify-content-center" data-id="{{ p.id }}">
          <input type="number" step="0.01" min="0" name="nuevo_precio" value="{{ p.valor_unitario }}"
                 class="form-control text-end" style="width:100px;" required>
          <button type="submit" class="btn btn-outline-success btn-sm ms-2">üíæ</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="8" class="text-end">Total Vendido Hoy</th>
      <th id="total-vendido-hoy">{{ "%.2f"|format(total_vendido) }}</th>
    </tr>
  </tfoot>
</table>
{% else %}
<div class="alert alert-info">No hay productos registrados todav√≠a.</div>
{% endif %}

<style>
.highlight { background-color: #c8f7c5 !important; transition: background-color 2s ease; }
.table-danger td { background-color: #f8d7da !important; }
.table-warning td { background-color: #fff3cd !important; }
#buscar-producto { max-width: 400px; }
@media (max-width: 768px) {
  .cantidad-input { width: 160px !important; height: 60px !important; font-size: 1.8rem !important; }
  .btn-success { font-size: 1.8rem !important; padding: 5px 20px !important; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // üîç Filtro de productos
  const inputBuscar = document.getElementById("buscar-producto");
  const tabla = document.getElementById("tabla-productos");
  const filas = tabla ? tabla.getElementsByTagName("tr") : [];

  inputBuscar.addEventListener("keyup", function() {
    const filtro = inputBuscar.value.toLowerCase();
    for (let i = 1; i < filas.length; i++) {
      const cols = filas[i].getElementsByTagName("td");
      if (cols.length === 0) continue;
      const codigo = cols[1].textContent.toLowerCase();
      const nombre = cols[2].textContent.toLowerCase();
      filas[i].style.display = (codigo.includes(filtro) || nombre.includes(filtro)) ? "" : "none";
    }
  });

  // üü¢ Desplazarse autom√°ticamente al producto reci√©n agregado
  if (window.location.hash) {
    const id = window.location.hash.substring(1);
    const fila = document.getElementById(id);
    if (fila) {
      fila.classList.add("highlight");
      fila.scrollIntoView({ behavior: "smooth", block: "center" });
      setTimeout(() => fila.classList.remove("highlight"), 4000);
    }
  }

  // üí≤ Editar precio sin recargar
  document.querySelectorAll(".form-editar-precio").forEach(form => {
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const id = form.dataset.id;
      const nuevo_precio = form.querySelector("input[name='nuevo_precio']").value;
      const fila = document.getElementById("producto-" + id);

      try {
        const res = await fetch(`/editar_precio/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nuevo_precio })
        });

        const data = await res.json();
        if (data.success) {
          // Actualizar visualmente el precio con ganancia
          const precioGanancia = fila.querySelector(".precio-ganancia");
          precioGanancia.textContent = data.precio_ganancia.toFixed(2);
          fila.classList.add("highlight");
          setTimeout(() => fila.classList.remove("highlight"), 3000);

          // Mostrar confirmaci√≥n
          const alertBox = document.createElement("div");
          alertBox.className = "alert alert-success position-fixed bottom-0 end-0 m-3 shadow";
          alertBox.textContent = `Precio actualizado para ${data.nombre}`;
          document.body.appendChild(alertBox);
          setTimeout(() => alertBox.remove(), 2500);
        } else {
          alert(data.error || "Error al actualizar el precio.");
        }
      } catch (err) {
        alert("Error de conexi√≥n con el servidor.");
      }
    });
  });
});
</script>
{% endblock %}
