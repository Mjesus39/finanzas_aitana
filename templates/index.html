{% extends "base.html" %}
{% block title %}üì¶ Inventario{% endblock %}

{% block content %}
<div class="container mt-4 inventario-contenedor">
  <h2 class="text-center mb-4 titulo-inventario">üì¶ Inventario de Productos</h2>

  <!-- üîπ Barra superior -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 gap-2 barra-superior">
    <div class="d-flex flex-wrap gap-2 acciones">
      <a class="btn btn-primary fw-semibold" href="{{ url_for('app_rutas.nuevo_producto') }}">
        ‚ûï Nuevo Producto
      </a>
      <a class="btn btn-secondary fw-semibold" href="{{ url_for('app_rutas.liquidacion') }}">
        üìä Ver Liquidaci√≥n
      </a>
    </div>
  </div>

  <!-- üîç Buscar -->
  <input 
    type="text" 
    id="buscar-producto" 
    class="form-control mb-3 buscador shadow-sm"
    placeholder="üîç Buscar producto por c√≥digo o nombre..."
  >

  {% if productos %}
  <div class="table-responsive">
    <table id="tabla-productos" class="table table-bordered table-hover align-middle text-center shadow-sm tabla-elegante">
      <thead class="table-dark">
        <tr>
          <th>Orden</th>
          <th>C√≥digo</th>
          <th>Nombre</th>
          <th>Precio con Ganancia</th>
          <th>Stock</th>
          <th>Vender</th>
          <th>Vendidas Hoy</th>
          <th>Valor Vendido</th>
        </tr>
      </thead>
      <tbody>
        {% for p in productos %}
        {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
        <tr id="producto-{{ p.id }}" class="{{ estado_class(p) }}">
          <td>{{ p.orden }}</td>

          <td class="col-codigo fw-semibold">{{ p.codigo }}</td>

          <td class="fw-bold col-nombre">{{ p.nombre }}</td>

          <td class="precio-ganancia text-primary fw-semibold">
            {{ "%.2f"|format(precio_ganancia) }}
          </td>

          <td class="stock-actual fw-bold">{{ p.unidades_restantes or 0 }}</td>

          <td>
            <form 
              class="form-vender d-flex justify-content-center" 
              data-id="{{ p.id }}" 
              data-action="{{ url_for('app_rutas.vender', producto_id=p.id) }}"
            >
              <input 
                type="number" 
                step="1" 
                min="1" 
                max="{{ p.unidades_restantes }}" 
                name="cantidad"
                placeholder="0" 
                class="form-control text-end cantidad-input fw-bold fs-5 input-vender"
                style="width:100px; height:46px;" 
                required
              >
              <button 
                type="submit" 
                class="btn btn-success ms-2 fs-5 btn-vender"
              >
                üíµ
              </button>
            </form>
          </td>

          <!-- üîµ Celda clickeable para abrir el modal de detalles del d√≠a -->
          <td class="vendidas-dia">
            <button 
              type="button"
              class="btn btn-link fw-bold text-decoration-none p-0 boton-detalle"
              data-producto-id="{{ p.id }}"
              data-producto-nombre="{{ p.nombre }}"
              data-producto-codigo="{{ p.codigo }}"
            >
              {{ p.vendidas_dia or 0 }}
            </button>
          </td>

          <td class="valor-vendido-dia fw-semibold text-success">
            {{ "%.2f"|format(p.valor_vendido_dia or 0) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot class="table-secondary fw-bold">
        <tr>
          <th colspan="7" class="text-end">üí∞ Total Vendido Hoy:</th>
          <th id="total-vendido-hoy" class="text-success">
            {{ "%.2f"|format(total_vendido or 0) }}
          </th>
        </tr>
      </tfoot>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info text-center mt-4 shadow-sm">
    No hay productos registrados todav√≠a.
  </div>
  {% endif %}
</div>

<!-- ü™ü Modal elegante: Detalle de ventas del d√≠a del producto -->
<div class="modal fade" id="modalDetallesVentas" tabindex="-1" aria-labelledby="modalDetallesVentasLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="modalDetallesVentasLabel">üìà Ventas del d√≠a</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body bg-light">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="fw-bold">C√≥digo: <span id="md-codigo" class="text-primary"></span></div>
            <div class="fw-bold">Producto: <span id="md-nombre" class="text-dark"></span></div>
          </div>
          <div class="text-end">
            <div class="small text-muted">Fecha (hora Chile)</div>
            <div class="small fw-semibold" id="md-fecha-hoy"></div>
          </div>
        </div>

        <div id="md-contenido">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center shadow-sm">
              <thead class="table-dark">
                <tr>
                  <th>üïí Hora</th>
                  <th>üî¢ Cantidad</th>
                  <th>üí∞ Ingreso</th>
                  <th>‚öôÔ∏è Acci√≥n</th>
                </tr>
              </thead>

              <tbody id="md-tbody">
                <!-- filas din√°micas -->
              </tbody>

              <tfoot class="table-secondary fw-bold">
                <tr>
                  <td class="text-end" colspan="2">Total</td>
                  <td id="md-total"></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="md-vacio" class="alert alert-info text-center d-none">
            üì≠ No hay ventas registradas hoy para este producto.
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>

<!-- ===================== -->
<!-- üé® ESTILOS COMPLETOS -->
<!-- ===================== -->
<style>

.inventario-contenedor {
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.titulo-inventario {
  font-weight: 900;
  color: #212529;
}

.buscador {
  border-radius: 10px;
  padding: 12px;
  font-size: 1.1rem;
}

.tabla-elegante {
  border-radius: 12px;
  overflow: hidden;
}

.tabla-elegante tbody tr:hover {
  background-color: #eef3ff !important;
}

.input-vender {
  border-radius: 10px;
  font-size: 1.2rem;
}

.boton-detalle {
  font-size: 1.1rem;
  color: #0d6efd;
}

.boton-detalle:hover {
  text-decoration: underline;
}

</style>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  // üéµ Toasts y sonido
  const toastOk = new bootstrap.Toast($("#toast-success"), { delay: 2000 });
  const toastErr = new bootstrap.Toast($("#toast-error"), { delay: 3000 });
  const okText = $("#toast-success-text"), errText = $("#toast-error-text");
  const sonidoOk = $("#sonido-ok");

  // üîç B√∫squeda
  const inputBuscar = $("#buscar-producto");
  inputBuscar?.addEventListener("keyup", () => {
    const f = inputBuscar.value.toLowerCase();
    $$("#tabla-productos tbody tr").forEach(tr => {
      const codigo = tr.querySelector(".col-codigo")?.textContent.toLowerCase() || "";
      const nombre = tr.querySelector(".col-nombre")?.textContent.toLowerCase() || "";
      tr.style.display = (codigo.includes(f) || nombre.includes(f)) ? "" : "none";
    });
  });

  // üõí Env√≠o AJAX de venta
  $$(".form-vender").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = form.querySelector(".btn-vender");
      const input = form.querySelector("input[name='cantidad']");
      const cantidad = parseInt(input.value);
      const id = form.dataset.id;
      const action = form.dataset.action;
      const fila = $("#producto-" + id);
      const stockEl = fila.querySelector(".stock-actual");
      const vendidasEl = fila.querySelector(".vendidas-dia");
      const valorEl = fila.querySelector(".valor-vendido-dia");
      const totalEl = $("#total-vendido-hoy");

      if (!cantidad || cantidad <= 0) {
        errText.textContent = "‚ö†Ô∏è Cantidad inv√°lida.";
        toastErr.show();
        return;
      }

      btn.disabled = true;
      try {
        const res = await fetch(action, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cantidad })
        });

        const data = await res.json();
        if (data.success) {
          // Actualizar interfaz
          stockEl.textContent = data.stock;
          vendidasEl.querySelector("button").textContent = data.vendidas_dia;
          valorEl.textContent = data.valor_vendido_dia.toFixed(2);
          totalEl.textContent = (parseFloat(totalEl.textContent) + data.monto).toFixed(2);

          // Efecto verde durante 5 segundos
input.classList.add("bg-success", "text-white");

setTimeout(() => {
    input.classList.remove("bg-success", "text-white");
}, 5000);

// Borrar el n√∫mero del input
input.value = "";
        } else {
          errText.textContent = data.error || "‚ùå Error al registrar la venta.";
          toastErr.show();
        }
      } catch (err) {
        errText.textContent = "‚ùå Error de conexi√≥n con el servidor.";
        toastErr.show();
      } finally {
        btn.disabled = false;
      }
    });
  });

  // ü™ü Modal de detalles
  const modalEl = $("#modalDetallesVentas");
  const modal = new bootstrap.Modal(modalEl);

  async function cargarDetalles(productoId, codigo, nombre) {
    $("#md-codigo").textContent = codigo;
    $("#md-nombre").textContent = nombre;
    $("#md-fecha-hoy").textContent = "";

    const tbody = $("#md-tbody");
    tbody.innerHTML = "";
    $("#md-total").textContent = "0.00";
    $("#md-vacio").classList.add("d-none");

    try {
      const res = await fetch(`/detalle_ventas_producto/${productoId}`);
      const data = await res.json();

      if (!data.success) throw new Error(data.error || "No fue posible cargar los detalles.");
      const ventas = data.ventas || [];
      let total = 0;

      if (ventas.length === 0) {
        $("#md-vacio").classList.remove("d-none");
      } else {
        ventas.forEach(v => {
          total += v.ingreso;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="text-primary fw-semibold">${v.fecha_chile}</td>
            <td>${v.cantidad}</td>
            <td class="text-success fw-bold">$${v.ingreso.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger eliminar-venta" data-venta-id="${v.id}" data-producto-id="${productoId}">
                üóë Eliminar
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      $("#md-total").textContent = `$${total.toFixed(2)}`;
      modal.show();
    } catch (e) {
      errText.textContent = "‚ùå No se pudieron cargar los detalles de ventas.";
      toastErr.show();
    }
  }

  $$(".ver-detalles-venta, .boton-detalle").forEach(btn => {
    btn.addEventListener("click", () => {
      const productoId = btn.dataset.productoId;
      const codigo = btn.dataset.productoCodigo;
      const nombre = btn.dataset.productoNombre;
      cargarDetalles(productoId, codigo, nombre);
    });
  });

  // üóë Eliminar venta desde modal
  $("#md-tbody")?.addEventListener("click", async (e) => {
    const btn = e.target.closest(".eliminar-venta");
    if (!btn) return;

    const ventaId = btn.dataset.ventaId;
    const productoId = btn.dataset.productoId;

    btn.disabled = true;
    try {
      const res = await fetch(`/eliminar_venta/${ventaId}`, { method: "POST" });
      const data = await res.json();

      if (!data.success) throw new Error(data.error || "No fue posible eliminar la venta.");

      const row = btn.closest("tr");
      const ingreso = parseFloat(row.children[2].textContent.replace("$","")) || 0;
      row.remove();

      let total = 0;
      $$("#md-tbody tr").forEach(tr => {
        const val = parseFloat(tr.children[2].textContent.replace("$","")) || 0;
        total += val;
      });

      $("#md-total").textContent = `$${total.toFixed(2)}`;
      if ($$("#md-tbody tr").length === 0) $("#md-vacio").classList.remove("d-none");

      const fila = $("#producto-" + productoId);
      fila.querySelector(".stock-actual").textContent = data.stock;
      fila.querySelector(".vendidas-dia button").textContent = data.vendidas_dia;
      fila.querySelector(".valor-vendido-dia").textContent = data.valor_vendido_dia.toFixed(2);

      const totalEl = $("#total-vendido-hoy");
      totalEl.textContent = (parseFloat(totalEl.textContent) - ingreso).toFixed(2);

      okText.textContent = "‚úÖ Venta eliminada y caja actualizada.";
      toastOk.show();
      sonidoOk.play();

    } catch (err) {
      errText.textContent = "‚ùå No se pudo eliminar la venta.";
      toastErr.show();
    } finally {
      btn.disabled = false;
    }
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const anchor = window.location.hash;
  if (anchor && anchor.startsWith("#producto-")) {
    const elemento = document.querySelector(anchor);
    if (elemento) {
      elemento.scrollIntoView({ behavior: "smooth", block: "center" });
      elemento.style.transition = "background-color 0.6s ease";
      elemento.style.backgroundColor = "#fffa8b";
      setTimeout(() => {
        elemento.style.backgroundColor = "";
      }, 2500);
    }
  }
});
</script>
{% endblock %}
