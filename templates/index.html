{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Productos</h2>

<div class="mb-3 d-flex flex-column flex-md-row gap-2">
    <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-primary" href="{{ url_for('nuevo_producto') }}">➕ Nuevo Producto</a>
        <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">📊 Ver Liquidación</a>
    </div>
    <input type="text" id="buscar-producto" class="form-control mt-2 mt-md-0" placeholder="Buscar producto por nombre o código...">
</div>

{% if productos %}
<table id="tabla-productos" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>Código</th>
      <th>Nombre</th>
      <th>Precio con Ganancia</th>
      <th>Unidades Iniciales</th>
      <th>Vender</th>
      <th>Unidades Vendidas (día)</th>
      <th>Valor Vendido (día)</th>
    </tr>
  </thead>
  <tbody>
    {% for p in productos %}
    {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    <tr class="{{ estado_class(p) }} {% if p.id == resaltado %}highlight{% endif %}" data-producto-id="{{ p.id }}">
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden_producto', producto_id=p.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ p.orden }}" class="form-control text-center" style="width:70px;">
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm">✔</button>
        </form>
      </td>

      <td>{{ p.codigo }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ "%.2f"|format(precio_ganancia) }}</td>
      <td>{{ p.unidades_restantes or 0 }}</td>

      <!-- Input de venta (agrandado y táctil) -->
      <td>
        <form action="{{ url_for('vender', producto_id=p.id) }}" method="post" class="d-flex form-vender justify-content-center">
          <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad"
                 placeholder="0" class="form-control text-end cantidad-input fs-5 fw-bold" 
                 style="width:120px; height:50px; font-size:1.4rem;" required>
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">💵</button>
        </form>
      </td>

      <td class="vendidas-dia fs-6">{{ p.vendidas_dia or 0 }}</td>
      <td class="valor-vendido-dia fs-6">{{ "%.2f"|format(p.valor_vendido_dia or 0) }}</td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="7" class="text-end">Total Vendido Hoy</th>
      <th>{{ "%.2f"|format(total_vendido) }}</th>
    </tr>
  </tfoot>
</table>
{% else %}
<div class="alert alert-info">No hay productos registrados todavía.</div>
{% endif %}

<style>
/* 🟢 Fila resaltada al vender */
.highlight {
  background-color: #d4edda !important;
  animation: fadeOut 2s ease 8s forwards;
}

/* 🎞️ Efecto de desvanecimiento */
@keyframes fadeOut {
  to {
    background-color: transparent;
  }
}

/* ⚠️ Bajo stock */
.table-danger td {
  background-color: #f8d7da !important;
}
.table-warning td {
  background-color: #fff3cd !important;
}

/* 🔍 Buscador */
#buscar-producto {
  max-width: 400px;
}

/* 📱 Ajustes para móviles */
@media (max-width: 768px) {
  .cantidad-input {
    width: 160px !important;
    height: 60px !important;
    font-size: 1.8rem !important;
  }
  .btn-success {
    font-size: 1.8rem !important;
    padding: 5px 20px !important;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const inputBuscar = document.getElementById("buscar-producto");
  const tabla = document.getElementById("tabla-productos");
  const filas = tabla ? tabla.getElementsByTagName("tr") : [];

  // 🔍 Filtrar productos por nombre o código
  inputBuscar.addEventListener("keyup", function() {
    const filtro = inputBuscar.value.toLowerCase();
    for (let i = 1; i < filas.length; i++) {
      const cols = filas[i].getElementsByTagName("td");
      if (cols.length === 0) continue;
      const codigo = cols[1].textContent.toLowerCase();
      const nombre = cols[2].textContent.toLowerCase();
      filas[i].style.display = (codigo.includes(filtro) || nombre.includes(filtro)) ? "" : "none";
    }
  });
});
</script>

{% endblock %}
