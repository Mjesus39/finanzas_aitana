
{% extends "base.html" %}

{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Productos</h2>

<div class="mb-3 d-flex gap-2">
    <a class="btn btn-primary" href="{{ url_for('nuevo_producto') }}">‚ûï Nuevo Producto</a>
    <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
    <input type="text" id="buscar-producto" class="form-control" placeholder="Buscar producto por nombre o c√≥digo...">
</div>

{% if productos %}
<table id="tabla-productos" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Precio con Ganancia</th>
      <th>Unidades Iniciales</th>
      <th>Vender</th>
      <th>Unidades Vendidas</th>
      <th>Valor Vendido</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for p in productos %}
    {% set vendidas = (p.stock_inicial or 0) - (p.unidades_restantes or 0) %}
    {% set valor_vendido = vendidas * (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    <tr class="{{ estado_class(p) }} {% if p.id == session.get('resaltado') %}highlight{% endif %}" data-producto-id="{{ p.id }}">
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden_producto', producto_id=p.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ p.orden }}" class="form-control text-center" style="width:70px;"/>
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm">‚úî</button>
        </form>
      </td>
      <td>{{ p.codigo }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ "%.2f"|format(precio_ganancia) }}</td>
      <td class="stock-inicial">{{ p.unidades_restantes or 0 }}</td>
      <td>
        <form action="{{ url_for('vender', producto_id=p.id) }}" method="post" class="d-flex">
          <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad" placeholder="0" class="form-control text-end cantidad-input" required/>
          <button type="submit" class="btn btn-success ms-1 btn-sm">üíµ</button>
        </form>
      </td>
      <td>{{ vendidas }}</td>
      <td class="valor-vendido">{{ "%.2f"|format(valor_vendido) }}</td>
      <td>
        <form action="{{ url_for('eliminar_producto', producto_id=p.id) }}" method="post">
          <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="7" class="text-end">Total Vendido</th>
      <th>{{ "%.2f"|format(total_vendido) }}</th>
      <th></th>
    </tr>
  </tfoot>
</table>
{% else %}
<div class="alert alert-info">No hay productos registrados todav√≠a.</div>
{% endif %}

<style>
/* Highlight verde temporal */
.highlight {
    background-color: #d4edda !important;
    transition: background-color 0.5s ease;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const inputBuscar = document.getElementById("buscar-producto");
    const tabla = document.getElementById("tabla-productos");
    const filas = tabla.getElementsByTagName("tr");

    // Filtrar productos por nombre o c√≥digo
    inputBuscar.addEventListener("keyup", function() {
        const filtro = inputBuscar.value.toLowerCase();
        for (let i = 1; i < filas.length; i++) { // omitir header
            const cols = filas[i].getElementsByTagName("td");
            if (cols.length === 0) continue;
            const codigo = cols[1].textContent.toLowerCase();
            const nombre = cols[2].textContent.toLowerCase();

            if (codigo.includes(filtro) || nombre.includes(filtro)) {
                filas[i].style.display = "";
            } else {
                filas[i].style.display = "none";
            }
        }
    });

    // Resaltar fila de venta reciente y enfocar input
    const resaltado = document.querySelector(".highlight");
    if (resaltado) {
        const inputCantidad = resaltado.querySelector(".cantidad-input");
        if (inputCantidad) inputCantidad.focus();
        setTimeout(() => {
            resaltado.classList.remove("highlight");
        }, 5000);
    }
});
</script>

{% endblock %}
