{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Productos</h2>

<div class="mb-3 d-flex gap-2">
    <a class="btn btn-primary" href="{{ url_for('nuevo_producto') }}">‚ûï Nuevo Producto</a>
    <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
    <input type="text" id="buscar-producto" class="form-control" placeholder="Buscar producto por nombre o c√≥digo...">
</div>

{% if productos %}
<table id="tabla-productos" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Precio con Ganancia</th>
      <th>Unidades Iniciales</th>
      <th>Vender</th>
      <th>Unidades Vendidas (d√≠a)</th>
      <th>Valor Vendido (d√≠a)</th>
    </tr>
  </thead>
  <tbody>
    {% for p in productos %}
    {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    <tr class="{{ estado_class(p) }} {% if p.id == session.get('resaltado') %}highlight{% endif %}" data-producto-id="{{ p.id }}">
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden_producto', producto_id=p.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ p.orden }}" class="form-control text-center" style="width:70px;">
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm">‚úî</button>
        </form>
      </td>

      <td>{{ p.codigo }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ "%.2f"|format(precio_ganancia) }}</td>
      <td>{{ p.unidades_restantes or 0 }}</td>

      <!-- Input de venta -->
      <td>
        <form action="{{ url_for('vender', producto_id=p.id) }}" method="post" class="d-flex form-vender">
          <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad" placeholder="0" class="form-control text-end cantidad-input" required>
          <button type="submit" class="btn btn-success ms-1 btn-sm">üíµ</button>
        </form>
      </td>

      <!-- Nuevas columnas: solo datos diarios -->
      <td class="vendidas-dia">{{ p.vendidas_dia or 0 }}</td>
      <td class="valor-vendido-dia">{{ "%.2f"|format(p.valor_vendido_dia or 0) }}</td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="7" class="text-end">Total Vendido Hoy</th>
      <th>{{ "%.2f"|format(total_vendido) }}</th>
    </tr>
  </tfoot>
</table>
{% else %}
<div class="alert alert-info">No hay productos registrados todav√≠a.</div>
{% endif %}

<style>
/* üü¢ Fila resaltada cuando se vende un producto */
.highlight {
  background-color: #d4edda !important;
  transition: background-color 0.5s ease;
}

/* Sutil sombreado para filas con poco stock */
.table-warning td, .table-danger td {
  transition: background-color 0.3s ease;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const inputBuscar = document.getElementById("buscar-producto");
  const tabla = document.getElementById("tabla-productos");
  const filas = tabla ? tabla.getElementsByTagName("tr") : [];

  // üîç Filtrar productos por nombre o c√≥digo
  inputBuscar.addEventListener("keyup", function() {
    const filtro = inputBuscar.value.toLowerCase();
    for (let i = 1; i < filas.length; i++) {
      const cols = filas[i].getElementsByTagName("td");
      if (cols.length === 0) continue;
      const codigo = cols[1].textContent.toLowerCase();
      const nombre = cols[2].textContent.toLowerCase();
      filas[i].style.display = (codigo.includes(filtro) || nombre.includes(filtro)) ? "" : "none";
    }
  });

  // üü© Efecto visual al vender: fila verde por 10 segundos
  const resaltado = document.querySelector(".highlight");
  if (resaltado) {
    setTimeout(() => resaltado.classList.remove("highlight"), 10000);
  }
});
</script>

{% endblock %}
