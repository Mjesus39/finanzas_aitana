{% extends "base.html" %}
{% block title %}Inicio{% endblock %}

{% block content %}
<h2 class="mb-4">Listado de Productos</h2>

<div class="mb-3 d-flex flex-column flex-md-row gap-2">
    <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-primary" href="{{ url_for('nuevo_producto') }}">‚ûï Nuevo Producto</a>
        <a class="btn btn-secondary" href="{{ url_for('liquidacion') }}">üìä Ver Liquidaci√≥n</a>
    </div>
    <input type="text" id="buscar-producto" class="form-control mt-2 mt-md-0" placeholder="Buscar producto por nombre o c√≥digo...">
</div>

{% if productos %}
<table id="tabla-productos" class="table table-bordered table-hover align-middle text-center">
  <thead class="table-dark">
    <tr>
      <th>Orden</th>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Precio con Ganancia</th>
      <th>Unidades Iniciales</th>
      <th>Vender</th>
      <th>Unidades Vendidas (d√≠a)</th>
      <th>Valor Vendido (d√≠a)</th>
    </tr>
  </thead>
  <tbody>
    {% for p in productos %}
    {% set precio_ganancia = (p.valor_unitario or 0) * (1 + (p.interes or 0)/100) %}
    <tr class="{{ estado_class(p) }} {% if p.id == resaltado %}highlight{% endif %}" data-producto-id="{{ p.id }}">
      <!-- Orden -->
      <td style="width:100px;">
        <form action="{{ url_for('actualizar_orden_producto', producto_id=p.id) }}" method="post" class="d-flex actualizar-orden-form">
          <input type="number" name="orden" value="{{ p.orden }}" class="form-control text-center" style="width:70px;">
          <button type="submit" class="btn btn-outline-primary ms-1 btn-sm">‚úî</button>
        </form>
      </td>

      <td>{{ p.codigo }}</td>
      <td>{{ p.nombre }}</td>
      <td>{{ "%.2f"|format(precio_ganancia) }}</td>
      <td class="stock-actual">{{ p.unidades_restantes or 0 }}</td>

      <!-- Input de venta -->
      <td>
        <form action="{{ url_for('vender', producto_id=p.id) }}" method="post" class="d-flex form-vender justify-content-center">
          <input type="number" step="1" min="1" max="{{ p.unidades_restantes }}" name="cantidad"
                 placeholder="0" class="form-control text-end cantidad-input fs-5 fw-bold" 
                 style="width:120px; height:50px; font-size:1.4rem;" required>
          <button type="submit" class="btn btn-success ms-2" style="font-size:1.4rem; padding:0 15px;">üíµ</button>
        </form>
      </td>

      <td class="vendidas-dia fs-6">{{ p.vendidas_dia or 0 }}</td>
      <td class="valor-vendido-dia fs-6">{{ "%.2f"|format(p.valor_vendido_dia or 0) }}</td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="7" class="text-end">Total Vendido Hoy</th>
      <th id="total-vendido-hoy">{{ "%.2f"|format(total_vendido) }}</th>
    </tr>
  </tfoot>
</table>
{% else %}
<div class="alert alert-info">No hay productos registrados todav√≠a.</div>
{% endif %}

<style>
/* üü¢ Fila resaltada al vender */
.highlight {
  background-color: #d4edda !important;
  animation: fadeOut 2s ease 3s forwards;
}

/* üéûÔ∏è Efecto de desvanecimiento */
@keyframes fadeOut {
  to { background-color: transparent; }
}

/* ‚ö†Ô∏è Bajo stock */
.table-danger td { background-color: #f8d7da !important; }
.table-warning td { background-color: #fff3cd !important; }

/* üîç Buscador */
#buscar-producto { max-width: 400px; }

/* üì± Ajustes para m√≥viles */
@media (max-width: 768px) {
  .cantidad-input {
    width: 160px !important;
    height: 60px !important;
    font-size: 1.8rem !important;
  }
  .btn-success {
    font-size: 1.8rem !important;
    padding: 5px 20px !important;
  }
}
</style>

<script>
// üîç Filtrar productos por nombre o c√≥digo
document.addEventListener("DOMContentLoaded", function() {
  const inputBuscar = document.getElementById("buscar-producto");
  const tabla = document.getElementById("tabla-productos");
  const filas = tabla ? tabla.getElementsByTagName("tr") : [];

  inputBuscar.addEventListener("keyup", function() {
    const filtro = inputBuscar.value.toLowerCase();
    for (let i = 1; i < filas.length; i++) {
      const cols = filas[i].getElementsByTagName("td");
      if (cols.length === 0) continue;
      const codigo = cols[1].textContent.toLowerCase();
      const nombre = cols[2].textContent.toLowerCase();
      filas[i].style.display = (codigo.includes(filtro) || nombre.includes(filtro)) ? "" : "none";
    }
  });
});

// üü¢ Registrar venta sin recargar
document.querySelectorAll(".form-vender").forEach(form => {
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const id = form.action.split("/").pop();
    const cantidad = form.querySelector("input[name='cantidad']").value;
    const fila = form.closest("tr");

    if (!cantidad || cantidad <= 0) return alert("Ingrese una cantidad v√°lida.");

    try {
      const res = await fetch(`/vender/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cantidad })
      });

      const data = await res.json();
      if (data.success) {
        // Actualizar fila
        const vendidasCelda = fila.querySelector(".vendidas-dia");
        const valorCelda = fila.querySelector(".valor-vendido-dia");
        const stockCelda = fila.querySelector(".stock-actual");

        vendidasCelda.textContent = parseInt(vendidasCelda.textContent) + data.cantidad;
        valorCelda.textContent = (parseFloat(valorCelda.textContent) + parseFloat(data.monto)).toFixed(2);
        stockCelda.textContent = data.stock;

        // Actualizar total vendido
        const totalHoy = document.getElementById("total-vendido-hoy");
        totalHoy.textContent = (parseFloat(totalHoy.textContent) + parseFloat(data.monto)).toFixed(2);

        // Resaltar fila
        fila.classList.add("highlight");
        setTimeout(() => fila.classList.remove("highlight"), 2000);

        // Limpiar campo
        form.querySelector("input[name='cantidad']").value = "";

        // Mostrar alerta elegante
        const alertBox = document.createElement("div");
        alertBox.className = "alert alert-success position-fixed bottom-0 end-0 m-3 shadow";
        alertBox.textContent = `Venta registrada: ${data.nombre} (${data.cantidad} uds - $${data.monto.toFixed(2)})`;
        document.body.appendChild(alertBox);
        setTimeout(() => alertBox.remove(), 2500);
      } else {
        alert(data.error || "Error al registrar la venta.");
      }
    } catch (err) {
      alert("Error de conexi√≥n con el servidor.");
    }
  });
});
</script>

{% endblock %}
