{% extends "base.html" %}
{% block title %}Liquidación{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>📊 Liquidación</h2>

    <!-- Selector de fecha -->
    <form id="form-fecha" method="POST" class="mb-3 d-flex align-items-center gap-2">
        <label for="fecha" class="fw-bold">📅 Fecha:</label>
        <input type="date" id="fecha" name="fecha" value="{{ fecha_consulta }}" class="form-control" style="width: 200px;">
        <button type="submit" class="btn btn-primary">🔍 Consultar</button>
    </form>

    <!-- Caja del día -->
    <div class="card mb-3">
        <div class="card-body">
            <h5>🧾 Liquidación del Día: <span id="fecha-dia">{{ fecha_consulta }}</span></h5>
            <p><strong>💵 Caja del Día:</strong> $<span id="caja-dia">{{ "%.2f"|format(total_caja) }}</span></p>
            <p><strong>📦 Inventario Total:</strong> $<span id="inventario-dia">{{ "%.2f"|format(inventario_valor) }}</span></p>
        </div>
    </div>

    <!-- Formularios de caja -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form action="{{ url_for('caja_entrada') }}" method="POST" class="d-flex gap-2">
                <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control" required>
                <input type="text" name="descripcion" placeholder="Descripción (opcional)" class="form-control">
                <button type="submit" class="btn btn-success">💰 Entrada</button>
            </form>
        </div>
        <div class="col-md-6">
            <form action="{{ url_for('caja_salida') }}" method="POST" class="d-flex gap-2">
                <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control" required>
                <input type="text" name="descripcion" placeholder="Descripción (opcional)" class="form-control">
                <button type="submit" class="btn btn-danger">💸 Salida</button>
            </form>
        </div>
    </div>

    <!-- Ingresar inventario -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>📦 Ingresar Inventario</h5>
            <form action="{{ url_for('ingresar_inventario_por_codigo') }}" method="POST" class="d-flex gap-2">
                <input type="text" name="codigo" placeholder="Código del producto" class="form-control" required>
                <input type="number" name="cantidad" step="1" placeholder="Cantidad" class="form-control" required>
                <button type="submit" class="btn btn-warning">📥 Ingresar</button>
            </form>
            <small class="text-muted">El inventario se actualizará automáticamente.</small>
        </div>
    </div>

    <!-- Tabla de ventas -->
    <h5 class="mt-4">🛒 Ventas del Día</h5>
    <div id="tabla-ventas">
        {% if ventas_dia %}
        <table class="table table-bordered table-striped text-center align-middle mt-2">
            <thead class="table-dark">
                <tr>
                    <th>Hora</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Ingreso</th>
                </tr>
            </thead>
            <tbody id="ventas-body">
                {% for v in ventas_dia %}
                <tr>
                    <td>{{ v.fecha.strftime("%H:%M") }}</td>
                    <td>{{ v.producto.nombre }}</td>
                    <td>{{ v.cantidad }}</td>
                    <td>${{ "%.2f"|format(v.ingreso) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">No hay ventas registradas para esta fecha.</div>
        {% endif %}
    </div>
</div>

<!-- 🔄 Autoactualización en vivo -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const formFecha = document.getElementById("form-fecha");
    const fechaInput = document.getElementById("fecha");
    const cajaDia = document.getElementById("caja-dia");
    const inventarioDia = document.getElementById("inventario-dia");
    const ventasBody = document.getElementById("ventas-body");
    const fechaDia = document.getElementById("fecha-dia");

    async function actualizarLiquidacion() {
        const fecha = fechaInput.value;
        const response = await fetch("/liquidacion", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `fecha=${fecha}`
        });

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Extraer los valores nuevos del HTML renderizado
        cajaDia.textContent = doc.querySelector("#caja-dia").textContent;
        inventarioDia.textContent = doc.querySelector("#inventario-dia").textContent;
        ventasBody.innerHTML = doc.querySelector("#ventas-body").innerHTML;
        fechaDia.textContent = fecha;
    }

    // Actualiza cada 10 segundos
    setInterval(actualizarLiquidacion, 10000);

    // Si el usuario cambia la fecha, se detiene el auto-update
    formFecha.addEventListener("submit", function() {
        clearInterval();
    });
});
</script>
{% endblock %}

