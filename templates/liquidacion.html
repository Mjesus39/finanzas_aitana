{% extends "base.html" %}
{% block title %}ğŸ“Š LiquidaciÃ³n de Productos{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- ğŸ”¹ ENCABEZADO PRINCIPAL -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">

    <!-- ğŸ’¸ Salida de Efectivo -->
    <form action="{{ url_for('app_rutas.caja_salida') }}" method="POST"
          class="d-flex flex-wrap align-items-center gap-2 shadow-sm p-3 bg-light rounded">
      <h5 class="mb-0 text-danger fw-bold">ğŸ’¸ Salida de Efectivo</h5>
      <input type="number" name="monto" step="0.01" min="0"
             placeholder="Valor" class="form-control" required style="width:120px;">
      <input type="text" name="descripcion" placeholder="Motivo"
             class="form-control" required style="width:200px;">
      <button type="submit" class="btn btn-danger fw-bold">Aplicar</button>
    </form>

    <!-- ğŸ“… Selector de fechas -->
    <form method="POST" class="d-flex flex-wrap justify-content-center align-items-center gap-2">
      <label class="fw-bold">Desde:</label>
      <input type="date" name="fecha_inicio" value="{{ fecha_inicio }}" class="form-control w-auto" required>
      <label class="fw-bold">Hasta:</label>
      <input type="date" name="fecha_fin" value="{{ fecha_fin }}" class="form-control w-auto" required>
      <button type="submit" class="btn btn-primary fw-bold">ğŸ” Buscar</button>
    </form>
  </div>

  <!-- ğŸ•’ Hora actual -->
  <p class="text-end text-muted mb-2">
    ğŸ•’ Hora actual en Chile: {{ hora_actual()|hora_chile }}
  </p>

  <!-- ğŸ—“ï¸ Ãšltima liquidaciÃ³n -->
  <p class="text-center fw-bold mb-4">
    ğŸ—“ï¸ Ãšltima liquidaciÃ³n:
    {{ ultima_fecha|hora_chile if ultima_fecha else "N/A" }}
  </p>


  {% if liquidaciones %}
  <!-- ====================================================== -->
  <!-- ğŸ’° RESUMEN RÃPIDO -->
  <!-- ====================================================== -->
  {% set liq = liquidaciones[0] %}
  <div class="row text-center mb-4">

    <div class="col-md-4 mb-2">
      <div class="card shadow-sm border-success">
        <div class="card-body">
          <h6 class="text-success fw-bold">ğŸ’° Caja anterior</h6>
          <h4 class="fw-bold">${{ "%.2f"|format(liq.caja_anterior or 0) }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-2">
      <div class="card shadow-sm border-primary">
        <div class="card-body">
          <h6 class="text-primary fw-bold">ğŸ’¸ Caja del dÃ­a</h6>
          <h4 class="fw-bold">${{ "%.2f"|format(liq.caja_dia or 0) }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-2">
      <div class="card shadow-sm border-warning">
        <div class="card-body">
          <h6 class="text-warning fw-bold">ğŸ“¦ Inventario total</h6>
          <h4 class="fw-bold">${{ "%.2f"|format(liq.inventario or 0) }}</h4>
        </div>
      </div>
    </div>

  </div>

  <!-- ====================================================== -->
  <!-- ğŸ“Š TABLA DE LIQUIDACIÃ“N -->
  <!-- ====================================================== -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>Fecha</th>
          <th>Caja anterior</th>
          <th>Ventas del dÃ­a</th>
          <th>Salidas</th>
          <th>Caja del dÃ­a</th>
          <th>Caja total acumulada</th>
          <th>Inventario</th>
        </tr>
      </thead>

      <tbody>
        {% for d in liquidaciones %}
        <tr>

          <td>{{ d.fecha|hora_chile }}</td>

          <td>${{ "%.2f"|format(d.caja_anterior or 0) }}</td>

          <!-- ğŸ’° Ventas del dÃ­a (clickeable) -->
          <td>
            <a href="{{ url_for('app_rutas.detalle_ventas', fecha=d.fecha.strftime('%Y-%m-%d')) }}"
               class="fw-bold text-success text-decoration-none">
              ${{ "%.2f"|format(d.ventas_dia or 0) }}
            </a>
          </td>

          <!-- ğŸ’¸ Salidas (clickeable) -->
          <td>
            <a href="{{ url_for('app_rutas.detalle_salida', fecha=d.fecha.strftime('%Y-%m-%d')) }}"
               class="fw-bold text-danger text-decoration-none">
              ${{ "%.2f"|format(d.salidas or 0) }}
            </a>
          </td>

          <td class="fw-bold text-primary">
            ${{ "%.2f"|format(d.caja_dia or 0) }}
          </td>

          <td class="fw-bold text-success">
            ${{ "%.2f"|format(d.caja_total or 0) }}
          </td>

          <td>
            ${{ "%.2f"|format(d.inventario or 0) }}
          </td>

        </tr>
        {% endfor %}
      </tbody>

      <!-- ====================================================== -->
      <!-- ğŸ§® PIE DE TOTALES -->
      <!-- ====================================================== -->
      <tfoot class="table-light fw-bold">
        <tr>
          <td>Total</td>
          <td>${{ "%.2f"|format(caja_inicial or 0) }}</td>
          <td>${{ "%.2f"|format(total_ventas or 0) }}</td>
          <td>${{ "%.2f"|format(total_salida or 0) }}</td>
          <td>${{ "%.2f"|format(caja_final or 0) }}</td>
          <td>${{ "%.2f"|format(caja_final or 0) }}</td>
          <td>${{ "%.2f"|format(total_paquete or 0) }}</td>
        </tr>
      </tfoot>

    </table>
  </div>

  {% else %}
  <div class="alert alert-info text-center">
    ğŸ“­ No se encontraron registros de liquidaciÃ³n.
  </div>
  {% endif %}

</div>
{% endblock %}
