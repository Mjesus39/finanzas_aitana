
{% extends "base.html" %}
{% block title %}LiquidaciÃ³n{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ“Š LiquidaciÃ³n</h2>

    <!-- Selector de fecha -->
    <form id="form-fecha" method="POST" class="mb-3 d-flex align-items-center gap-2">
        <label for="fecha" class="fw-bold">ğŸ“… Fecha:</label>
        <input type="date" id="fecha" name="fecha" value="{{ fecha_consulta }}" class="form-control" style="width: 200px;">
        <button type="submit" class="btn btn-primary">ğŸ” Consultar</button>
    </form>

    <!-- ğŸ’° Caja total acumulada -->
    <div class="card border-success mb-3">
        <div class="card-body">
            <h5>ğŸ’° <a href="{{ url_for('caja_total') }}" class="text-success text-decoration-none">
                Caja Total Acumulada
            </a>:</h5>
            <h4 class="fw-bold text-success">$ {{ "%.2f"|format(caja_total_global) }}</h4>
            <small class="text-muted">Haz clic para ver el desglose diario.</small>
        </div>
    </div>

    <!-- ğŸ§¾ Caja del dÃ­a -->
    <div class="card mb-3 shadow-sm">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h5>ğŸ§¾ LiquidaciÃ³n del DÃ­a: <span id="fecha-dia">{{ fecha_consulta }}</span></h5>
                <p><strong>ğŸ’µ Caja del DÃ­a:</strong> $<span id="caja-dia">{{ "%.2f"|format(total_caja) }}</span></p>
                <p><strong>ğŸ“¦ Inventario Total:</strong> $<span id="inventario-dia">{{ "%.2f"|format(inventario_valor) }}</span></p>
            </div>

            <!-- ğŸ”— BotÃ³n de detalle de caja -->
            <div class="text-md-end">
                <a href="{{ url_for('detalle_dia', fecha=date.today().strftime('%Y-%m-%d')) }}"
                   class="btn btn-outline-primary fw-bold px-4 shadow-sm">
                    ğŸ“… Ver Detalle de Caja de Hoy
                </a>
            </div>
        </div>
    </div>

    <!-- Formularios de caja -->
    <div class="row mb-4">
        <div class="col-md-6">
            <form action="{{ url_for('caja_entrada') }}" method="POST" class="d-flex gap-2">
                <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control" required>
                <input type="text" name="descripcion" placeholder="DescripciÃ³n (opcional)" class="form-control">
                <button type="submit" class="btn btn-success">ğŸ’° Entrada</button>
            </form>
        </div>
        <div class="col-md-6">
            <form action="{{ url_for('caja_salida') }}" method="POST" class="d-flex gap-2">
                <input type="number" name="monto" step="0.01" placeholder="Monto" class="form-control" required>
                <input type="text" name="descripcion" placeholder="DescripciÃ³n (opcional)" class="form-control">
                <button type="submit" class="btn btn-danger">ğŸ’¸ Salida</button>
            </form>
        </div>
    </div>

    <!-- Ingresar inventario -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>ğŸ“¦ Ingresar Inventario</h5>
            <form action="{{ url_for('ingresar_inventario_por_codigo') }}" method="POST" class="d-flex gap-2">
                <input type="text" name="codigo" placeholder="CÃ³digo del producto" class="form-control" required>
                <input type="number" name="cantidad" step="1" placeholder="Cantidad" class="form-control" required>
                <button type="submit" class="btn btn-warning">ğŸ“¥ Ingresar</button>
            </form>
            <small class="text-muted">El inventario se actualizarÃ¡ automÃ¡ticamente.</small>
        </div>
    </div>

    <!-- Tabla de ventas -->
    <h5 class="mt-4">ğŸ›’ Ventas del DÃ­a</h5>
    <div id="tabla-ventas">
        {% if ventas_dia %}
        <table class="table table-bordered table-striped text-center align-middle mt-2">
            <thead class="table-dark">
                <tr>
                    <th>Hora</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Ingreso</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="ventas-body">
                {% for v in ventas_dia %}
                <tr>
                    <td>{{ v.fecha.strftime("%H:%M") }}</td>
                    <td>{{ v.producto.nombre }}</td>
                    <td>{{ v.cantidad }}</td>
                    <td>${{ "%.2f"|format(v.ingreso) }}</td>
                    <td>
                        <form action="{{ url_for('eliminar_venta', venta_id=v.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">No hay ventas registradas para esta fecha.</div>
        {% endif %}
    </div>
</div>

<!-- ğŸ”„ AutoactualizaciÃ³n -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const formFecha = document.getElementById("form-fecha");
    const fechaInput = document.getElementById("fecha");
    const cajaDia = document.getElementById("caja-dia");
    const inventarioDia = document.getElementById("inventario-dia");
    const ventasBody = document.getElementById("ventas-body");
    const fechaDia = document.getElementById("fecha-dia");

    async function actualizarLiquidacion() {
        const fecha = fechaInput.value;
        const response = await fetch("/liquidacion", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `fecha=${fecha}`
        });

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        cajaDia.textContent = doc.querySelector("#caja-dia").textContent;
        inventarioDia.textContent = doc.querySelector("#inventario-dia").textContent;
        ventasBody.innerHTML = doc.querySelector("#ventas-body").innerHTML;
        fechaDia.textContent = fecha;
    }

    setInterval(actualizarLiquidacion, 10000);
    formFecha.addEventListener("submit", () => clearInterval());
});
</script>
{% endblock %}
