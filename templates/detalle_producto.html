{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Detalle de Productos - {{ fecha.strftime("%d/%m/%Y") }}</h2>

  {% if productos %}
  <table class="table table-bordered table-hover mt-3">
    <thead class="table-dark">
      <tr>
        <th>Orden</th>
        <th>Código</th>
        <th>Fecha</th>
        <th>Nombre del Producto</th>
        <th class="text-end">Unidades Iniciales</th>
        <th class="text-end">Unidades Vendidas</th>
        <th class="text-end">Valor Vendido</th>
        <th class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in productos %}
      <tr id="producto-{{ p.id }}">
        <td>{{ p.orden }}</td>
        <td>{{ p.codigo }}</td>
        <td>{{ p.fecha.strftime("%d/%m/%Y") }}</td>
        <td>{{ p.nombre }}</td>
        <td class="text-end" id="unidades-{{ p.id }}">{{ p.unidades_restantes }}</td>

        <td class="text-end">
          <form action="{{ url_for('vender_producto', producto_id=p.id) }}" method="post" class="d-flex justify-content-end vender-form">
            <input type="number" name="unidades_vendidas" min="1" max="{{ p.unidades_restantes }}" 
                   class="form-control text-end unidades-input" style="width:80px;" placeholder="0" required>
            <button type="submit" class="btn btn-success btn-sm ms-1">✔</button>
          </form>
        </td>

        <td class="text-end" id="valor-{{ p.id }}">{{ "%.2f"|format(p.valor_vendido) }}</td>

        <td class="text-center">
          <form action="{{ url_for('eliminar_producto', producto_id=p.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-danger btn-sm"
                    onclick="return confirm('¿Seguro que deseas eliminar este producto?')">❌</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot class="table-light">
      <tr>
        <th colspan="5" class="text-end">Totales:</th>
        <th class="text-end" id="total-unidades">{{ total_unidades_vendidas }}</th>
        <th class="text-end" id="total-valor">{{ "%.2f"|format(total_valor_vendido) }}</th>
        <th></th>
      </tr>
    </tfoot>
  </table>
  {% else %}
  <div class="alert alert-warning mt-3">No hay productos registrados en esta fecha.</div>
  {% endif %}

  <a href="{{ url_for('liquidacion') }}" class="btn btn-secondary mt-3">Volver a Liquidación</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const forms = document.querySelectorAll(".vender-form");

  forms.forEach((form, idx) => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = form.querySelector(".unidades-input");
      const unidades = parseInt(input.value);
      const productoId = form.action.split('/').pop();
      const tdUnidades = document.getElementById("unidades-" + productoId);
      const tdValor = document.getElementById("valor-" + productoId);

      if (isNaN(unidades) || unidades <= 0) {
        alert("Ingrese un número válido de unidades");
        return;
      }

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: `unidades_vendidas=${unidades}`
        });
        const data = await response.json();

        if (data.success) {
          tdUnidades.textContent = data.unidades_restantes;
          tdValor.textContent = parseFloat(data.valor_vendido).toFixed(2);
          input.value = "";
          form.closest("tr").classList.add("abono-realizado");

          // Actualizar totales
          document.getElementById("total-unidades").textContent = data.total_unidades_vendidas;
          document.getElementById("total-valor").textContent = parseFloat(data.total_valor_vendido).toFixed(2);

          // Pasar foco al siguiente input
          const nextForm = forms[idx + 1];
          if (nextForm) nextForm.querySelector(".unidades-input").focus();
        } else {
          alert(data.mensaje);
        }
      } catch (err) {
        console.error(err);
        alert("Error al registrar la venta.");
      }
    });
  });
});
</script>
{% endblock %}

